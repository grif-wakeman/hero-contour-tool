class B{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),i?.once){const n=(...s)=>{this.un(t,n),e(...s)};return this.listeners[t].add(n),()=>this.un(t,n)}return this.listeners[t].add(e),()=>this.un(t,e)}un(t,e){var i;(i=this.listeners[t])===null||i===void 0||i.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((i=>i(...e)))}}class T extends B{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function w(v,t,e,i,n=3,s=0,r=100){if(!v)return()=>{};const a=matchMedia("(pointer: coarse)").matches;let o=()=>{};const l=h=>{if(h.button!==s)return;h.preventDefault(),h.stopPropagation();let c=h.clientX,g=h.clientY,u=!1;const z=Date.now(),b=d=>{if(d.preventDefault(),d.stopPropagation(),a&&Date.now()-z<r)return;const p=d.clientX,m=d.clientY,C=p-c,L=m-g;if(u||Math.abs(C)>n||Math.abs(L)>n){const R=v.getBoundingClientRect(),{left:D,top:S}=R;u||(e?.(c-D,g-S),u=!0),t(C,L,p-D,m-S),c=p,g=m}},x=d=>{if(u){const p=d.clientX,m=d.clientY,C=v.getBoundingClientRect(),{left:L,top:R}=C;i?.(p-L,m-R)}o()},E=d=>{d.relatedTarget&&d.relatedTarget!==document.documentElement||x(d)},y=d=>{u&&(d.stopPropagation(),d.preventDefault())},k=d=>{u&&d.preventDefault()};document.addEventListener("pointermove",b),document.addEventListener("pointerup",x),document.addEventListener("pointerout",E),document.addEventListener("pointercancel",E),document.addEventListener("touchmove",k,{passive:!1}),document.addEventListener("click",y,{capture:!0}),o=()=>{document.removeEventListener("pointermove",b),document.removeEventListener("pointerup",x),document.removeEventListener("pointerout",E),document.removeEventListener("pointercancel",E),document.removeEventListener("touchmove",k),setTimeout((()=>{document.removeEventListener("click",y,{capture:!0})}),10)}};return v.addEventListener("pointerdown",l),()=>{o(),v.removeEventListener("pointerdown",l)}}function P(v,t){const e=t.xmlns?document.createElementNS(t.xmlns,v):document.createElement(v);for(const[i,n]of Object.entries(t))if(i==="children"&&n)for(const[s,r]of Object.entries(n))r instanceof Node?e.appendChild(r):typeof r=="string"?e.appendChild(document.createTextNode(r)):e.appendChild(P(s,r));else i==="style"?Object.assign(e.style,n):i==="textContent"?e.textContent=n:e.setAttribute(i,n.toString());return e}function f(v,t,e){const i=P(v,t||{});return e?.appendChild(i),i}class O extends B{constructor(t,e,i=0){var n,s,r,a,o,l,h,c,g,u;super(),this.totalDuration=e,this.numberOfChannels=i,this.element=null,this.minLength=0,this.maxLength=1/0,this.contentEditable=!1,this.subscriptions=[],this.updatingSide=void 0,this.isRemoved=!1,this.subscriptions=[],this.id=t.id||`region-${Math.random().toString(32).slice(2)}`,this.start=this.clampPosition(t.start),this.end=this.clampPosition((n=t.end)!==null&&n!==void 0?n:t.start),this.drag=(s=t.drag)===null||s===void 0||s,this.resize=(r=t.resize)===null||r===void 0||r,this.resizeStart=(a=t.resizeStart)===null||a===void 0||a,this.resizeEnd=(o=t.resizeEnd)===null||o===void 0||o,this.color=(l=t.color)!==null&&l!==void 0?l:"rgba(0, 0, 0, 0.1)",this.minLength=(h=t.minLength)!==null&&h!==void 0?h:this.minLength,this.maxLength=(c=t.maxLength)!==null&&c!==void 0?c:this.maxLength,this.channelIdx=(g=t.channelIdx)!==null&&g!==void 0?g:-1,this.contentEditable=(u=t.contentEditable)!==null&&u!==void 0?u:this.contentEditable,this.element=this.initElement(),this.setContent(t.content),this.setPart(),this.renderPosition(),this.initMouseEvents()}clampPosition(t){return Math.max(0,Math.min(this.totalDuration,t))}setPart(){var t;const e=this.start===this.end;(t=this.element)===null||t===void 0||t.setAttribute("part",`${e?"marker":"region"} ${this.id}`)}addResizeHandles(t){const e={position:"absolute",zIndex:"2",width:"6px",height:"100%",top:"0",cursor:"ew-resize",wordBreak:"keep-all"},i=f("div",{part:"region-handle region-handle-left",style:Object.assign(Object.assign({},e),{left:"0",borderLeft:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"2px 0 0 2px"})},t),n=f("div",{part:"region-handle region-handle-right",style:Object.assign(Object.assign({},e),{right:"0",borderRight:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"0 2px 2px 0"})},t);this.subscriptions.push(w(i,(s=>this.onResize(s,"start")),(()=>null),(()=>this.onEndResizing("start")),1),w(n,(s=>this.onResize(s,"end")),(()=>null),(()=>this.onEndResizing("end")),1))}removeResizeHandles(t){const e=t.querySelector('[part*="region-handle-left"]'),i=t.querySelector('[part*="region-handle-right"]');e&&t.removeChild(e),i&&t.removeChild(i)}initElement(){if(this.isRemoved)return null;const t=this.start===this.end;let e=0,i=100;this.channelIdx>=0&&this.numberOfChannels>0&&this.channelIdx<this.numberOfChannels&&(i=100/this.numberOfChannels,e=i*this.channelIdx);const n=f("div",{style:{position:"absolute",top:`${e}%`,height:`${i}%`,backgroundColor:t?"none":this.color,borderLeft:t?"2px solid "+this.color:"none",borderRadius:"2px",boxSizing:"border-box",transition:"background-color 0.2s ease",cursor:this.drag?"grab":"default",pointerEvents:"all"}});return!t&&this.resize&&this.addResizeHandles(n),n}renderPosition(){if(!this.element)return;const t=this.start/this.totalDuration,e=(this.totalDuration-this.end)/this.totalDuration;this.element.style.left=100*t+"%",this.element.style.right=100*e+"%"}toggleCursor(t){var e;this.drag&&(!((e=this.element)===null||e===void 0)&&e.style)&&(this.element.style.cursor=t?"grabbing":"grab")}initMouseEvents(){const{element:t}=this;t&&(t.addEventListener("click",(e=>this.emit("click",e))),t.addEventListener("mouseenter",(e=>this.emit("over",e))),t.addEventListener("mouseleave",(e=>this.emit("leave",e))),t.addEventListener("dblclick",(e=>this.emit("dblclick",e))),t.addEventListener("pointerdown",(()=>this.toggleCursor(!0))),t.addEventListener("pointerup",(()=>this.toggleCursor(!1))),this.subscriptions.push(w(t,(e=>this.onMove(e)),(()=>this.toggleCursor(!0)),(()=>{this.toggleCursor(!1),this.drag&&this.emit("update-end")}))),this.contentEditable&&this.content&&(this.contentClickListener=e=>this.onContentClick(e),this.contentBlurListener=()=>this.onContentBlur(),this.content.addEventListener("click",this.contentClickListener),this.content.addEventListener("blur",this.contentBlurListener)))}_onUpdate(t,e,i){var n;if(!(!((n=this.element)===null||n===void 0)&&n.parentElement))return;const{width:s}=this.element.parentElement.getBoundingClientRect(),r=t/s*this.totalDuration;let a=e&&e!=="start"?this.start:this.start+r,o=e&&e!=="end"?this.end:this.end+r;const l=i!==void 0;l&&this.updatingSide&&this.updatingSide!==e&&(this.updatingSide==="start"?a=i:o=i),a=Math.max(0,a),o=Math.min(this.totalDuration,o);const h=o-a;this.updatingSide=e;const c=h>=this.minLength&&h<=this.maxLength;a<=o&&(c||l)&&(this.start=a,this.end=o,this.renderPosition(),this.emit("update",e))}onMove(t){this.drag&&this._onUpdate(t)}onResize(t,e){this.resize&&(this.resizeStart||e!=="start")&&(this.resizeEnd||e!=="end")&&this._onUpdate(t,e)}onEndResizing(t){this.resize&&(this.emit("update-end",t),this.updatingSide=void 0)}onContentClick(t){t.stopPropagation(),t.target.focus(),this.emit("click",t)}onContentBlur(){this.emit("update-end")}_setTotalDuration(t){this.totalDuration=t,this.renderPosition()}play(t){this.emit("play",t&&this.end!==this.start?this.end:void 0)}getContent(t=!1){var e;return t?this.content||void 0:this.element instanceof HTMLElement?((e=this.content)===null||e===void 0?void 0:e.innerHTML)||void 0:""}setContent(t){var e;if(this.element)if(this.content&&this.contentEditable&&(this.contentClickListener&&this.content.removeEventListener("click",this.contentClickListener),this.contentBlurListener&&this.content.removeEventListener("blur",this.contentBlurListener)),(e=this.content)===null||e===void 0||e.remove(),t){if(typeof t=="string"){const i=this.start===this.end;this.content=f("div",{style:{padding:`0.2em ${i?.2:.4}em`,display:"inline-block"},textContent:t})}else this.content=t;this.contentEditable&&(this.content.contentEditable="true",this.contentClickListener=i=>this.onContentClick(i),this.contentBlurListener=()=>this.onContentBlur(),this.content.addEventListener("click",this.contentClickListener),this.content.addEventListener("blur",this.contentBlurListener)),this.content.setAttribute("part","region-content"),this.element.appendChild(this.content),this.emit("content-changed")}else this.content=void 0}setOptions(t){var e,i;if(this.element){if(t.color&&(this.color=t.color,this.element.style.backgroundColor=this.color),t.drag!==void 0&&(this.drag=t.drag,this.element.style.cursor=this.drag?"grab":"default"),t.start!==void 0||t.end!==void 0){const n=this.start===this.end;this.start=this.clampPosition((e=t.start)!==null&&e!==void 0?e:this.start),this.end=this.clampPosition((i=t.end)!==null&&i!==void 0?i:n?this.start:this.end),this.renderPosition(),this.setPart()}if(t.content&&this.setContent(t.content),t.id&&(this.id=t.id,this.setPart()),t.resize!==void 0&&t.resize!==this.resize){const n=this.start===this.end;this.resize=t.resize,this.resize&&!n?this.addResizeHandles(this.element):this.removeResizeHandles(this.element)}t.resizeStart!==void 0&&(this.resizeStart=t.resizeStart),t.resizeEnd!==void 0&&(this.resizeEnd=t.resizeEnd)}}remove(){this.isRemoved=!0,this.emit("remove"),this.subscriptions.forEach((t=>t())),this.element&&(this.element.remove(),this.element=null)}}class M extends T{constructor(t){super(t),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(t){return new M(t)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer),this.subscriptions.push(this.wavesurfer.on("ready",(e=>{this.regions.forEach((i=>i._setTotalDuration(e)))})));let t=[];this.subscriptions.push(this.wavesurfer.on("timeupdate",(e=>{const i=this.regions.filter((n=>n.start<=e&&(n.end===n.start?n.start+.05:n.end)>=e));i.forEach((n=>{t.includes(n)||this.emit("region-in",n)})),t.forEach((n=>{i.includes(n)||this.emit("region-out",n)})),t=i})))}initRegionsContainer(){return f("div",{part:"regions-container",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"5",pointerEvents:"none"}})}getRegions(){return this.regions}avoidOverlapping(t){t.content&&setTimeout((()=>{const e=t.content,i=e.getBoundingClientRect(),n=this.regions.map((s=>{if(s===t||!s.content)return 0;const r=s.content.getBoundingClientRect();return i.left<r.left+r.width&&r.left<i.left+i.width?r.height:0})).reduce(((s,r)=>s+r),0);e.style.marginTop=`${n}px`}),10)}adjustScroll(t){var e,i;if(!t.element)return;const n=(i=(e=this.wavesurfer)===null||e===void 0?void 0:e.getWrapper())===null||i===void 0?void 0:i.parentElement;if(!n)return;const{clientWidth:s,scrollWidth:r}=n;if(r<=s)return;const a=n.getBoundingClientRect(),o=t.element.getBoundingClientRect(),l=o.left-a.left,h=o.right-a.left;l<0?n.scrollLeft+=l:h>s&&(n.scrollLeft+=h-s)}virtualAppend(t,e,i){const n=()=>{if(!this.wavesurfer)return;const s=this.wavesurfer.getWidth(),r=this.wavesurfer.getScroll(),a=e.clientWidth,o=this.wavesurfer.getDuration(),l=Math.round(t.start/o*a),h=l+(Math.round((t.end-t.start)/o*a)||1)>r&&l<r+s;h&&!i.parentElement?e.appendChild(i):!h&&i.parentElement&&i.remove()};setTimeout((()=>{if(!this.wavesurfer||!t.element)return;n();const s=this.wavesurfer.on("scroll",n),r=this.wavesurfer.on("zoom",n);this.subscriptions.push(s,r),t.once("remove",(()=>{s(),r()}))}),0)}saveRegion(t){if(!t.element)return;this.virtualAppend(t,this.regionsContainer,t.element),this.avoidOverlapping(t),this.regions.push(t);const e=[t.on("update",(i=>{i||this.adjustScroll(t),this.emit("region-update",t,i)})),t.on("update-end",(i=>{this.avoidOverlapping(t),this.emit("region-updated",t,i)})),t.on("play",(i=>{var n;(n=this.wavesurfer)===null||n===void 0||n.play(t.start,i)})),t.on("click",(i=>{this.emit("region-clicked",t,i)})),t.on("dblclick",(i=>{this.emit("region-double-clicked",t,i)})),t.on("content-changed",(()=>{this.emit("region-content-changed",t)})),t.once("remove",(()=>{e.forEach((i=>i())),this.regions=this.regions.filter((i=>i!==t)),this.emit("region-removed",t)}))];this.subscriptions.push(...e),this.emit("region-created",t)}addRegion(t){var e,i;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const n=this.wavesurfer.getDuration(),s=(i=(e=this.wavesurfer)===null||e===void 0?void 0:e.getDecodedData())===null||i===void 0?void 0:i.numberOfChannels,r=new O(t,n,s);return this.emit("region-initialized",r),n?this.saveRegion(r):this.subscriptions.push(this.wavesurfer.once("ready",(a=>{r._setTotalDuration(a),this.saveRegion(r)}))),r}enableDragSelection(t,e=3){var i;const n=(i=this.wavesurfer)===null||i===void 0?void 0:i.getWrapper();if(!(n&&n instanceof HTMLElement))return()=>{};let s=null,r=0,a=0;return w(n,((o,l,h)=>{s&&s._onUpdate(o,h>r?"end":"start",a)}),(o=>{var l,h;if(r=o,!this.wavesurfer)return;const c=this.wavesurfer.getDuration(),g=(h=(l=this.wavesurfer)===null||l===void 0?void 0:l.getDecodedData())===null||h===void 0?void 0:h.numberOfChannels,{width:u}=this.wavesurfer.getWrapper().getBoundingClientRect();a=r/u*c;const z=o/u*c,b=(o+5)/u*c;s=new O(Object.assign(Object.assign({},t),{start:z,end:b}),c,g),this.emit("region-initialized",s),s.element&&this.regionsContainer.appendChild(s.element)}),(()=>{s&&(this.saveRegion(s),s.updatingSide=void 0,s=null)}),e)}clearRegions(){this.regions.slice().forEach((t=>t.remove())),this.regions=[]}destroy(){this.clearRegions(),super.destroy(),this.regionsContainer.remove()}}export{M as default};
